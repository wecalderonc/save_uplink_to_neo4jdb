version: '3'
services:
  test:
    image: zonawik1/save_uplink_to_neo4jdb:1
    command:
      - /bin/bash
      - -c
      - |
        echo "dbms.security.auth_enabled=false" >> /etc/neo4j/neo4j.conf
        service neo4j start
        sleep 5
        bundle
        rake neo4j:generate_schema_migration[constraint,Accumulator,uuid]
        rake neo4j:generate_schema_migration[constraint,Alarm,uuid]
        rake neo4j:generate_schema_migration[constraint,BatteryLevel,uuid]
        rake neo4j:generate_schema_migration[constraint,Sensor1,uuid]
        rake neo4j:generate_schema_migration[constraint,Sensor2,uuid]
        rake neo4j:generate_schema_migration[constraint,Sensor3,uuid]
        rake neo4j:generate_schema_migration[constraint,Sensor4,uuid]
        rake neo4j:generate_schema_migration[constraint,Thing,uuid]
        rake neo4j:generate_schema_migration[constraint,TimeUplink,uuid]
        rake neo4j:generate_schema_migration[constraint,UplinkBDownlink,uuid]
        rake neo4j:generate_schema_migration[constraint,Uplink,uuid]
        rake neo4j:generate_schema_migration[constraint,ValvePosition,uuid]
        rake neo4j:migrate
        cypher-shell -u neo4j -p neo4j-password "CREATE (:Thing {name: '2BEE82'});"
        rspec
        chmod +x bin/shot
        bin/shot
    volumes:
      - .:/lambda_docker
    tty: true
    stdin_open: true

  update:
     image: zonawik1/save_uplink_to_neo4jdb:1
     command: >
       bash -c "apt-get install -y zip &&
       bundle install --path vendor/bundle --without development test &&
       rm -r vendor/bundle/ruby/2.5.0/cache &&
       zip -9 -r lambda_function.zip lambda_function.rb vendor app config lib &&
       aws lambda update-function-code --function-name  arn:aws:lambda:us-east-1:247246293844:function:SaveToNeo4jDB --zip-file fileb://lambda_function.zip"
     volumes:
       - .:/lambda_docker
     tty: true
     stdin_open: true
